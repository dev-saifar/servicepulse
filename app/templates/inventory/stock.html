{% extends "_layouts/base.html" %}
{% set title = "Stock On Hand" %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <h3 class="me-auto">Stock On Hand</h3>
  <a class="btn btn-outline-primary me-2" href="{{ url_for('inventory.grn_form') }}">Receive (GRN)</a>
  <a class="btn btn-outline-secondary me-2" href="{{ url_for('inventory.issue_form') }}">Issue / Return</a>
  <a class="btn btn-outline-dark" href="{{ url_for('inventory.transfer_form') }}">Transfer</a>
</div>

<div class="table-responsive">
  <table id="soh" class="table table-striped table-hover align-middle" style="width:100%">
    <thead class="table-light">
      <tr>
        <th>SKU</th>
        <th>Name</th>
        <th>Bin</th>
        <th class="text-end">Qty</th>
        <th class="text-end">Avg Cost (USD)</th>
        <th class="text-end">Value (USD)</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><code>{{ r.sku }}</code></td>
        <td>{{ r.name }}</td>
        <td>{{ r.bin_code }}</td>
        <td class="text-end">{{ '%.3f'|format(r.qty_on_hand or 0) }}</td>
        <td class="text-end">{{ '%.6f'|format(r.avg_cost_usd or 0) }}</td>
        <td class="text-end">{{ '%.2f'|format(r.value_usd or 0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot class="table-light">
      <tr>
        <th colspan="5" class="text-end">Total</th>
        <th class="text-end" id="totalVal">0.00</th>
      </tr>
    </tfoot>
  </table>
</div>
{% endblock %}

{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const table = new DataTable('#soh', {
    responsive: true,
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'print'],
    order: [[0, 'asc']]
  });

  // Sum value column
  const api = table;
  const recalc = () => {
    let total = 0;
    api.rows({search: 'applied'}).every(function () {
      const v = parseFloat(this.data()[5].toString().replace(/,/g,''));
      if (!isNaN(v)) total += v;
    });
    document.getElementById('totalVal').innerText = total.toFixed(2);
  };
  table.on('draw', recalc);
  recalc();
});
</script>
{% endblock %}
