{% extends 'base.html' %}

{% block content %}
<div class="container my-4 settings-page">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-1"><i class="fas fa-sliders-h me-2"></i>ServicePulse Settings</h3>
      <div class="text-muted">Configure email, backups, branding, data import, and log housekeeping.</div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
          {{ message|safe }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-backup" data-bs-toggle="tab" data-bs-target="#panel-backup" type="button" role="tab">
        <i class="fas fa-database me-1"></i> Backup
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-smtp" data-bs-toggle="tab" data-bs-target="#panel-smtp" type="button" role="tab">
        <i class="fas fa-envelope me-1"></i> SMTP
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-branding" data-bs-toggle="tab" data-bs-target="#panel-branding" type="button" role="tab">
        <i class="fas fa-palette me-1"></i> Branding
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-import" data-bs-toggle="tab" data-bs-target="#panel-import" type="button" role="tab">
        <i class="fas fa-file-import me-1"></i> Data Import
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <!-- BACKUP TAB -->
    <div class="tab-pane fade show active" id="panel-backup" role="tabpanel" aria-labelledby="tab-backup">
      <div class="row g-3">

        <!-- LEFT: Configure -->
        <div class="col-12 col-xxl-7">
          <div class="card shadow-sm">
            <div class="card-header d-flex align-items-center justify-content-between">
              <strong><i class="fas fa-hard-drive me-2"></i>Local Backup</strong>
              <span class="badge bg-{{ 'success' if backup.enabled=='True' else 'secondary' }}">{{ 'Enabled' if backup.enabled=='True' else 'Disabled' }}</span>
            </div>
            <div class="card-body">
              <form id="backupForm" method="POST" action="{{ url_for('settings.settings_page') }}">
                <input type="hidden" name="backup_save" value="1">

                <div class="row g-3">
                  <div class="col-12">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="DB_BACKUP_ENABLED" name="DB_BACKUP_ENABLED" {{ 'checked' if backup.enabled=='True' }}>
                      <label class="form-check-label" for="DB_BACKUP_ENABLED">Run daily backup</label>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Backup time</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="far fa-clock"></i></span>
                      <input type="time" class="form-control" name="DB_BACKUP_TIME" value="{{ backup.time }}" step="60">
                    </div>
                    <div class="form-text">Server local time.</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Retention (days)</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-calendar-minus"></i></span>
                      <input type="number" min="1" class="form-control" name="DB_BACKUP_KEEP_DAYS" value="{{ backup.keep }}">
                    </div>
                    <div class="form-text">Older files are pruned automatically.</div>
                  </div>

                  <div class="col-12">
                    <label for="DB_BACKUP_DIR" class="form-label">Backup folder (server)</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-folder"></i></span>
                      <input type="text" class="form-control" id="DB_BACKUP_DIR" name="DB_BACKUP_DIR"
                             value="{{ backup.dir }}" placeholder="{{ backup.quick_default|replace('\\','/') }}">
                      <a class="btn btn-outline-secondary" href="{{ url_for('settings.browse_dir', path=backup.dir) }}">Browse (server)</a>
                      <button type="button" class="btn btn-outline-secondary" id="btnCopyPath" title="Copy path"><i class="far fa-copy"></i></button>
                      <a class="btn btn-outline-secondary" href="{{ url_for('settings.backup_test_dir', path=backup.dir) }}" title="Test write"><i class="fas fa-wand-magic-sparkles"></i></a>
                    </div>
                    <div class="form-text">
                      Use forward slashes on Windows (e.g. <code>D:/path/to/folder</code>). Quick set:
                      <a href="#" id="setQuickDefault">App default</a> Â·
                      <a href="#" id="setQuickInstance">Instance path</a>
                    </div>
                  </div>
                </div>

                <hr class="my-4">

                <div class="accordion" id="backupAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSMB">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSMB">
                        <i class="fas fa-network-wired me-2"></i>Network Share (SMB)
                      </button>
                    </h2>
                    <div id="collapseSMB" class="accordion-collapse collapse" data-bs-parent="#backupAccordion">
                      <div class="accordion-body">
                        <div class="form-check form-switch mb-2">
                          <input class="form-check-input" type="checkbox" id="SMB_ENABLED" name="SMB_ENABLED" {{ 'checked' if backup.smb_enabled=='True' }}>
                          <label class="form-check-label" for="SMB_ENABLED">Enable SMB for UNC paths</label>
                        </div>
                        <div class="mb-2">
                          <label class="form-label">SMB share (e.g. <code>\\\\server\\share</code>)</label>
                          <input type="text" class="form-control" name="SMB_SHARE" value="{{ backup.smb_share }}">
                        </div>
                        <div class="row g-2">
                          <div class="col-md-6">
                            <label class="form-label">SMB user</label>
                            <input type="text" class="form-control" name="SMB_USER" value="{{ backup.smb_user }}">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">SMB password</label>
                            <input type="password" class="form-control" name="SMB_PASSWORD" value="">
                          </div>
                        </div>
                        <div class="form-text mt-2">Only needed if your backup folder is a UNC path (e.g. <code>\\\\server\\share\\backups</code>).</div>
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingGDrive">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGDrive">
                        <i class="fab fa-google-drive me-2"></i>Google Drive (optional)
                      </button>
                    </h2>
                    <div id="collapseGDrive" class="accordion-collapse collapse" data-bs-parent="#backupAccordion">
                      <div class="accordion-body">
                        <div class="form-check form-switch mb-2">
                          <input class="form-check-input" type="checkbox" id="GDRIVE_ENABLED" name="GDRIVE_ENABLED" {{ 'checked' if backup.gdrive_enabled=='True' }}>
                          <label class="form-check-label" for="GDRIVE_ENABLED">Upload each backup to Google Drive</label>
                        </div>
                        <div class="mb-2">
                          <label class="form-label">Folder ID / URL</label>
                          <input type="text" class="form-control" name="GDRIVE_FOLDER_ID" value="{{ backup.gdrive_folder }}" placeholder="Folder ID or full URL">
                          <div class="form-text">Drive libs installed: <strong>{{ backup.gdrive_libs }}</strong></div>
                        </div>
                        <div class="alert alert-secondary mb-0">Upload your service account JSON in the separate panel below.</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                  <button type="submit" class="btn btn-primary" id="btnSaveBackup"><i class="fas fa-save me-1"></i> Save Backup Settings</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Separate (not nested) Drive key upload -->
          <div class="card shadow-sm mt-3">
            <div class="card-header"><strong><i class="fas fa-key me-2"></i>Google Drive Service Account Key</strong></div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('settings.upload_gdrive_key') }}" enctype="multipart/form-data" class="d-flex gap-2">
                <input type="file" class="form-control" name="gdrive_key" accept=".json" required>
                <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-upload me-1"></i> Upload JSON</button>
              </form>
              {% if backup.gdrive_key_path %}
                <div class="form-text mt-2">Current key: <code>{{ backup.gdrive_key_path }}</code></div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- RIGHT: Status / Actions / Files & Logs housekeeping -->
        <div class="col-12 col-xxl-5">
          <div class="card shadow-sm mb-3">
            <div class="card-header"><strong><i class="fas fa-gauge me-2"></i>Environment</strong></div>
            <div class="card-body">
              <div class="small text-muted mb-1">Folder</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-truncate" style="max-width: 100%;">{{ backup.dir }}</code>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <div class="small text-muted">Writable</div>
                  <span class="badge {{ 'bg-success' if backup_stats.writable else 'bg-danger' }}">{{ 'Yes' if backup_stats.writable else 'No' }}</span>
                </div>
                <div class="col-6">
                  <div class="small text-muted">Exists</div>
                  <span class="badge {{ 'bg-success' if backup_stats.exists else 'bg-danger' }}">{{ 'Yes' if backup_stats.exists else 'No' }}</span>
                </div>
              </div>

              {% if backup_stats.total %}
              <div class="mt-3">
                <div class="small text-muted mb-1">Disk usage</div>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: {{ backup_stats.used_pct }}%;" aria-valuenow="{{ backup_stats.used_pct }}" aria-valuemin="0" aria-valuemax="100">{{ backup_stats.used_pct }}%</div>
                </div>
                <div class="small text-muted mt-1">
                  Used: {{ _bytes_fmt(backup_stats.used or 0) }} / Total: {{ _bytes_fmt(backup_stats.total or 0) }} Â· Free: {{ _bytes_fmt(backup_stats.free or 0) }}
                </div>
              </div>
              {% endif %}

              <div class="mt-3 d-flex flex-wrap gap-3 small">
                <div>Backups: <strong>{{ backup_stats.file_count }}</strong></div>
                <div>Total size: <strong>{{ _bytes_fmt(backup_stats.total_size) }}</strong></div>
                <div>Prune candidates: <strong>{{ backup_stats.prune_count }}</strong></div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm mb-3">
            <div class="card-header"><strong><i class="fas fa-clipboard-check me-2"></i>Status</strong></div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-sm-6">
                  <div class="small text-muted">Last backup</div>
                  <div class="fs-6 fw-semibold">{{ backup.last }}</div>
                  <div>Status:
                    <span class="badge {{ 'bg-success' if backup.last_status.startswith('SUCCESS') else 'bg-danger' }}">{{ backup.last_status }}</span>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="small text-muted">Next run</div>
                  <div class="fs-6 fw-semibold">{{ backup.next_run }}</div>
                </div>
                <div class="col-sm-6">
                  <div class="small text-muted">Cloud (Drive)</div>
                  <div>Last: <strong>{{ backup.cloud_last }}</strong></div>
                  <div class="text-wrap">Status:
                    <span class="badge {{ 'bg-success' if backup.cloud_status=='SUCCESS' else 'bg-secondary' }}">{{ backup.cloud_status }}</span>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="small text-muted">DB file (if SQLite)</div>
                  <div class="text-truncate"><code>{{ backup.db_path }}</code></div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <form method="POST" action="{{ url_for('settings.backup_now') }}">
                  <button class="btn btn-outline-primary action-once"><i class="fas fa-play me-1"></i> Backup Now</button>
                </form>
                <form method="POST" action="{{ url_for('settings.backup_upload_last') }}">
                  <button class="btn btn-outline-secondary action-once" {{ 'disabled' if backup.gdrive_enabled!='True' }} title="{{ 'Enable Google Drive above' if backup.gdrive_enabled!='True' else '' }}">
                    <i class="fab fa-google-drive me-1"></i> Upload Last to Drive
                  </button>
                </form>
                <form method="POST" action="{{ url_for('settings.backup_prune_now') }}">
                  <button class="btn btn-outline-danger action-once"><i class="fas fa-broom me-1"></i> Prune Old Now</button>
                </form>
              </div>
            </div>
          </div>

          <!-- Log housekeeping -->
          <div class="card shadow-sm mb-3">
            <div class="card-header">
              <strong><i class="fas fa-trash-can-clock me-2"></i>Log Housekeeping</strong>
            </div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('settings.settings_page') }}" class="row g-3">
                <input type="hidden" name="log_save" value="1">

                <div class="col-12">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="LOG_RETENTION_ENABLED"
                           name="LOG_RETENTION_ENABLED" {{ 'checked' if log.enabled=='True' }}>
                    <label class="form-check-label" for="LOG_RETENTION_ENABLED">Enable daily cleanup</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Keep logs for (days)</label>
                  <input type="number" min="1" class="form-control" name="LOG_RETENTION_DAYS" value="{{ log.days }}">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Cleanup time</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="far fa-clock"></i></span>
                    <input type="time" class="form-control" name="LOG_CLEAN_TIME" value="{{ log.time }}" step="60">
                  </div>
                </div>

                <div class="col-12 d-flex justify-content-end gap-2">
                  <button class="btn btn-primary"><i class="fas fa-save me-1"></i> Save</button>
                </div>
              </form>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <form method="POST" action="{{ url_for('settings.log_clean_now') }}">
                  <button class="btn btn-outline-danger action-once" type="submit"><i class="fas fa-broom me-1"></i> Run Cleanup Now</button>
                </form>
              </div>

              <hr class="my-3">
              <div class="row g-3 small">
                <div class="col-sm-6">
                  <div class="text-muted">Last run</div>
                  <div class="fw-semibold">{{ log.last }}</div>
                  <div>Status:
                    <span class="badge {{ 'bg-success' if log.last_status.startswith('SUCCESS') else 'bg-secondary' }}">{{ log.last_status }}</span>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="text-muted">Next run</div>
                  <div class="fw-semibold">{{ log.next_run }}</div>
                </div>
              </div>
              <div class="form-text mt-2">This permanently deletes rows from the Log table older than the retention window.</div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="fas fa-folder-tree me-2"></i>Local Backups</strong></div>
            <div class="card-body">
              {% if backup_files %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>File</th>
                        <th class="text-nowrap">Size</th>
                        <th class="text-nowrap">Modified</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for f in backup_files %}
                        <tr>
                          <td class="text-truncate"><code>{{ f.name }}</code></td>
                          <td class="text-nowrap">{{ _bytes_fmt(f.size) }}</td>
                          <td class="text-nowrap">{{ f.mtime.strftime('%Y-%m-%d %H:%M') if f.mtime else '' }}</td>
                          <td class="text-end d-flex justify-content-end gap-2">
                            <a class="btn btn-sm btn-outline-success" href="{{ url_for('settings.backup_download', name=f.name) }}"><i class="fas fa-download"></i></a>
                            <form method="POST" action="{{ url_for('settings.backup_delete', name=f.name) }}" onsubmit="return confirm('Delete {{ f.name }}?');">
                              <button class="btn btn-sm btn-outline-danger action-once"><i class="fas fa-trash"></i></button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted">No .backup files found yet.</div>
              {% endif %}
              <div class="mt-2 small text-muted">
                Quick paths:
                <code class="d-block">{{ backup.quick_default }}</code>
                <code class="d-block">{{ backup.quick_instance }}</code>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    <!-- /BACKUP TAB -->

    <!-- SMTP TAB -->
    <div class="tab-pane fade" id="panel-smtp" role="tabpanel" aria-labelledby="tab-smtp">
      <div class="row g-3">
        <div class="col-12 col-xl-7">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="fas fa-envelope-open-text me-2"></i>SMTP Settings</strong></div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('settings.settings_page') }}">
                <input type="hidden" name="smtp_save" value="1">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Mail server</label>
                    <input type="text" name="MAIL_SERVER" class="form-control" value="{{ smtp.get('MAIL_SERVER','') }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Mail port</label>
                    <input type="number" name="MAIL_PORT" class="form-control" value="{{ smtp.get('MAIL_PORT','587') }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Username</label>
                    <input type="text" name="MAIL_USERNAME" class="form-control" value="{{ smtp.get('MAIL_USERNAME','') }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Password</label>
                    <input type="password" name="MAIL_PASSWORD" class="form-control" value="{{ smtp.get('MAIL_PASSWORD','') }}">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Default sender (email)</label>
                    <input type="email" name="MAIL_DEFAULT_SENDER" class="form-control" value="{{ smtp.get('MAIL_DEFAULT_SENDER','') }}">
                  </div>
                  <div class="col-md-4 d-flex align-items-center">
                    <div class="form-check form-switch mt-4">
                      <input class="form-check-input" type="checkbox" id="MAIL_USE_TLS" name="MAIL_USE_TLS" {{ 'checked' if smtp.get('MAIL_USE_TLS','False')=='True' }}>
                      <label class="form-check-label" for="MAIL_USE_TLS">Use TLS</label>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-end mt-4">
                  <button class="btn btn-primary"><i class="fas fa-save me-1"></i> Save SMTP</button>
                </div>
              </form>

              <hr>
              <div class="d-flex align-items-center justify-content-between">
                <div class="text-muted small">Send a quick test email to verify your SMTP settings.</div>
                <form method="POST" action="{{ url_for('settings.test_email') }}" class="d-flex gap-2">
                  <input type="email" name="test_email" class="form-control" placeholder="test@example.com" required>
                  <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-paper-plane me-1"></i> Test</button>
                </form>
              </div>

            </div>
          </div>
        </div>

        <div class="col-12 col-xl-5">
          <div class="card shadow-sm">
            <div class="card-header"><strong><i class="fas fa-info-circle me-2"></i>Tips</strong></div>
            <div class="card-body">
              <ul class="small mb-0">
                <li>Most providers require <strong>TLS</strong> and ports like <code>587</code> or <code>465</code>.</li>
                <li>If you use an app password, paste it in the Password field.</li>
                <li>Check your mail logs if the Test email fails.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /SMTP TAB -->

    <!-- BRANDING TAB -->
    <div class="tab-pane fade" id="panel-branding" role="tabpanel" aria-labelledby="tab-branding">
      <div class="card shadow-sm">
        <div class="card-header"><strong><i class="fas fa-paint-brush me-2"></i>Branding</strong></div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('settings.settings_page') }}" enctype="multipart/form-data">
            <input type="hidden" name="branding_save" value="1">

            <div class="row g-3">
              <div class="col-lg-6">
                <label class="form-label">Company name</label>
                <input type="text" class="form-control" name="BRAND_COMPANY_NAME" value="{{ brand.company_name }}">
              </div>
              <div class="col-lg-6">
                <label class="form-label">Document title format</label>
                <input type="text" class="form-control" name="BRAND_DOC_TITLE_FORMAT" value="{{ brand.doc_fmt }}">
                <div class="form-text">Placeholders: <code>{company_name}</code>, <code>{doc_type}</code></div>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="BRAND_DOC_TYPE_UPPER" name="BRAND_DOC_TYPE_UPPER" {{ 'checked' if brand.doc_upper=='True' }}>
                  <label class="form-check-label" for="BRAND_DOC_TYPE_UPPER">Uppercase document type</label>
                </div>
              </div>
            </div>

            <hr class="my-4">

            {% set brand_fields = [
              ('BRAND_LOGO_LIGHT','logo_light','Logo (Light BG)'),
              ('BRAND_LOGO_DARK','logo_dark','Logo (Dark BG)'),
              ('BRAND_LOGO_ICON','logo_icon','Icon'),
              ('BRAND_WATERMARK','watermark','Watermark'),
              ('BRAND_STAMP','stamp','Stamp / Seal')
            ] %}
            <div class="row g-3">
              {% for var_key, field, label in brand_fields %}
              <div class="col-12 col-md-6 col-xl-4">
                <div class="border rounded p-3 h-100">
                  <div class="fw-semibold mb-2">{{ label }}</div>
                  {% set current_path = brand[field] %}
                  {% if current_path %}
                    <div class="mb-2">
                      <img src="{{ current_path }}" alt="{{ label }}" class="img-fluid border rounded bg-white p-1" style="max-height:110px">
                    </div>
                  {% else %}
                    <div class="text-muted small mb-2">No image uploaded.</div>
                  {% endif %}
                  <input class="form-control" type="file" name="{{ field }}" accept="image/*">
                  <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="clear_{{ field }}" name="clear_{{ field }}">
                    <label class="form-check-label small" for="clear_{{ field }}">Clear existing</label>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <div class="mt-4">
              <div class="small text-muted mb-2">Preview titles</div>
              <div class="row g-2">
                {% for p in brand_previews %}
                  <div class="col-md-4">
                    <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                      <span>{{ p.name }}</span>
                      <span class="badge bg-light text-dark">{{ p.title }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Branding</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- /BRANDING TAB -->

    <!-- DATA IMPORT TAB -->
    <div class="tab-pane fade" id="panel-import" role="tabpanel" aria-labelledby="tab-import">
      <div class="card shadow-sm">
        <div class="card-header"><strong><i class="fas fa-file-arrow-up me-2"></i>Data Import</strong></div>
        <div class="card-body">
          <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-circle-info me-2"></i>
            Upload <code>.xlsx</code> files that match the template columns.
          </div>

          <div class="row g-3">
            {% for m in import_models %}
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="border rounded p-3 h-100">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="fw-semibold text-uppercase">{{ m }}</div>
                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('settings.download_template', model=m) }}">
                    <i class="fas fa-download me-1"></i> Template
                  </a>
                </div>
                <form class="mt-2" method="POST" action="{{ url_for('settings.upload_excel', table=m) }}" enctype="multipart/form-data">
                  <div class="input-group">
                    <input class="form-control" type="file" name="file" accept=".xlsx" required>
                    <button class="btn btn-primary" type="submit"><i class="fas fa-upload me-1"></i> Upload</button>
                  </div>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>

        </div>
      </div>
    </div>
    <!-- /DATA IMPORT TAB -->
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(() => {
  const inputDir = document.getElementById('DB_BACKUP_DIR');
  const qd = document.getElementById('setQuickDefault');
  const qi = document.getElementById('setQuickInstance');
  if (qd) qd.addEventListener('click', e => { e.preventDefault(); inputDir.value = "{{ backup.quick_default|replace('\\','/') }}"; });
  if (qi) qi.addEventListener('click', e => { e.preventDefault(); inputDir.value = "{{ backup.quick_instance|replace('\\','/') }}"; });

  // Copy path
  const btnCopy = document.getElementById('btnCopyPath');
  if (btnCopy) btnCopy.addEventListener('click', () => {
    navigator.clipboard.writeText(inputDir.value || '').then(() => {
      btnCopy.innerHTML = '<i class="fas fa-check"></i>';
      setTimeout(() => btnCopy.innerHTML = '<i class="far fa-copy"></i>', 900);
    });
  });

  // Prevent double submits on action buttons
  document.querySelectorAll('.action-once').forEach(btn => {
    btn.addEventListener('click', function () {
      setTimeout(() => { this.setAttribute('disabled', 'disabled'); }, 0);
    });
  });

  const btnSave = document.getElementById('btnSaveBackup');
  if (btnSave) btnSave.addEventListener('click', function(){ setTimeout(() => this.setAttribute('disabled','disabled'), 0); });
})();
</script>

<style>
.settings-page .nav-tabs .nav-link { font-weight: 600; }
.settings-page .card-header { background: #f9fafb; }
.settings-page .form-text a { text-decoration: none; }
.settings-page .accordion-button:not(.collapsed) { background: #f1f5f9; }
.text-wrap { word-break: break-word; }
</style>
{% endblock %}
