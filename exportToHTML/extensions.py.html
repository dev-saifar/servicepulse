<html>
<head>
<title>extensions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
extensions.py</font>
</center></td></tr></table>
<pre><span class="s0"># Disable type checking for this module since numba's internals</span>
<span class="s0"># are not typed, and we use numba's internals via its extension API</span>
<span class="s0"># mypy: ignore-errors</span>
<span class="s2">&quot;&quot;&quot; 
Utility classes/functions to let numba recognize 
pandas Index/Series/DataFrame 
 
Mostly vendored from https://github.com/numba/numba/blob/main/numba/tests/pdlike_usecase.py 
&quot;&quot;&quot;</span>

<span class="s3">from </span><span class="s1">__future__ </span><span class="s3">import </span><span class="s1">annotations</span>

<span class="s3">from </span><span class="s1">contextlib </span><span class="s3">import </span><span class="s1">contextmanager</span>
<span class="s3">import </span><span class="s1">operator</span>

<span class="s3">import </span><span class="s1">numba</span>
<span class="s3">from </span><span class="s1">numba </span><span class="s3">import </span><span class="s1">types</span>
<span class="s3">from </span><span class="s1">numba</span><span class="s4">.</span><span class="s1">core </span><span class="s3">import </span><span class="s1">cgutils</span>
<span class="s3">from </span><span class="s1">numba</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">datamodel </span><span class="s3">import </span><span class="s1">models</span>
<span class="s3">from </span><span class="s1">numba</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">extending </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">NativeValue</span><span class="s4">,</span>
    <span class="s1">box</span><span class="s4">,</span>
    <span class="s1">lower_builtin</span><span class="s4">,</span>
    <span class="s1">make_attribute_wrapper</span><span class="s4">,</span>
    <span class="s1">overload</span><span class="s4">,</span>
    <span class="s1">overload_attribute</span><span class="s4">,</span>
    <span class="s1">overload_method</span><span class="s4">,</span>
    <span class="s1">register_model</span><span class="s4">,</span>
    <span class="s1">type_callable</span><span class="s4">,</span>
    <span class="s1">typeof_impl</span><span class="s4">,</span>
    <span class="s1">unbox</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">numba</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">imputils </span><span class="s3">import </span><span class="s1">impl_ret_borrowed</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>

<span class="s3">from </span><span class="s1">pandas</span><span class="s4">.</span><span class="s1">_libs </span><span class="s3">import </span><span class="s1">lib</span>

<span class="s3">from </span><span class="s1">pandas</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">indexes</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s1">Index</span>
<span class="s3">from </span><span class="s1">pandas</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">indexing </span><span class="s3">import </span><span class="s1">_iLocIndexer</span>
<span class="s3">from </span><span class="s1">pandas</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">internals </span><span class="s3">import </span><span class="s1">SingleBlockManager</span>
<span class="s3">from </span><span class="s1">pandas</span><span class="s4">.</span><span class="s1">core</span><span class="s4">.</span><span class="s1">series </span><span class="s3">import </span><span class="s1">Series</span>


<span class="s0"># Helper function to hack around fact that Index casts numpy string dtype to object</span>
<span class="s0">#</span>
<span class="s0"># Idea is to set an attribute on a Index called _numba_data</span>
<span class="s0"># that is the original data, or the object data casted to numpy string dtype,</span>
<span class="s0"># with a context manager that is unset afterwards</span>
<span class="s4">@</span><span class="s1">contextmanager</span>
<span class="s3">def </span><span class="s1">set_numba_data</span><span class="s4">(</span><span class="s1">index</span><span class="s4">: </span><span class="s1">Index</span><span class="s4">):</span>
    <span class="s1">numba_data </span><span class="s4">= </span><span class="s1">index</span><span class="s4">.</span><span class="s1">_data</span>
    <span class="s3">if </span><span class="s1">numba_data</span><span class="s4">.</span><span class="s1">dtype </span><span class="s4">== </span><span class="s1">object</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">lib</span><span class="s4">.</span><span class="s1">is_string_array</span><span class="s4">(</span><span class="s1">numba_data</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s5">&quot;The numba engine only supports using string or numeric column names&quot;</span>
            <span class="s4">)</span>
        <span class="s1">numba_data </span><span class="s4">= </span><span class="s1">numba_data</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s5">&quot;U&quot;</span><span class="s4">)</span>
    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">index</span><span class="s4">.</span><span class="s1">_numba_data </span><span class="s4">= </span><span class="s1">numba_data</span>
        <span class="s3">yield </span><span class="s1">index</span>
    <span class="s3">finally</span><span class="s4">:</span>
        <span class="s3">del </span><span class="s1">index</span><span class="s4">.</span><span class="s1">_numba_data</span>


<span class="s0"># TODO: Range index support</span>
<span class="s0"># (this currently lowers OK, but does not round-trip)</span>
<span class="s3">class </span><span class="s1">IndexType</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">Type</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    The type class for Index objects. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">layout</span><span class="s4">, </span><span class="s1">pyclass</span><span class="s4">: </span><span class="s1">any</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">pyclass </span><span class="s4">= </span><span class="s1">pyclass</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s5">f&quot;index(</span><span class="s3">{</span><span class="s1">dtype</span><span class="s3">}</span><span class="s5">, </span><span class="s3">{</span><span class="s1">layout</span><span class="s3">}</span><span class="s5">)&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dtype </span><span class="s4">= </span><span class="s1">dtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">layout </span><span class="s4">= </span><span class="s1">layout</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pyclass</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">layout</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">as_array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">layout</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">copy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">ndim</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">, </span><span class="s1">layout</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
        <span class="s3">if </span><span class="s1">dtype </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">dtype </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span>
        <span class="s1">layout </span><span class="s4">= </span><span class="s1">layout </span><span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">layout</span>
        <span class="s3">return </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)(</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">layout</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">pyclass</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">SeriesType</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">Type</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    The type class for Series objects. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">namety</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dtype </span><span class="s4">= </span><span class="s1">dtype</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">index </span><span class="s4">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">values </span><span class="s4">= </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;C&quot;</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">namety </span><span class="s4">= </span><span class="s1">namety</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s5">f&quot;series(</span><span class="s3">{</span><span class="s1">dtype</span><span class="s3">}</span><span class="s5">, </span><span class="s3">{</span><span class="s1">index</span><span class="s3">}</span><span class="s5">, </span><span class="s3">{</span><span class="s1">namety</span><span class="s3">}</span><span class="s5">)&quot;</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">namety</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">as_array</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">values</span>

    <span class="s3">def </span><span class="s1">copy</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">ndim</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">1</span><span class="s4">, </span><span class="s1">layout</span><span class="s4">: </span><span class="s1">str </span><span class="s4">= </span><span class="s5">&quot;C&quot;</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
        <span class="s3">assert </span><span class="s1">layout </span><span class="s4">== </span><span class="s5">&quot;C&quot;</span>
        <span class="s3">if </span><span class="s1">dtype </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">dtype </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dtype</span>
        <span class="s3">return </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)(</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">namety</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">typeof_impl</span><span class="s4">.</span><span class="s1">register</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">typeof_index</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    This will assume that only strings are in object dtype 
    index. 
    (you should check this before this gets lowered down to numba) 
    &quot;&quot;&quot;</span>
    <span class="s0"># arrty = typeof_impl(val._data, c)</span>
    <span class="s1">arrty </span><span class="s4">= </span><span class="s1">typeof_impl</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">_numba_data</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
    <span class="s3">return </span><span class="s1">IndexType</span><span class="s4">(</span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">layout</span><span class="s4">, </span><span class="s1">type</span><span class="s4">(</span><span class="s1">val</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">typeof_impl</span><span class="s4">.</span><span class="s1">register</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">typeof_series</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s1">index </span><span class="s4">= </span><span class="s1">typeof_impl</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
    <span class="s1">arrty </span><span class="s4">= </span><span class="s1">typeof_impl</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">values</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
    <span class="s1">namety </span><span class="s4">= </span><span class="s1">typeof_impl</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
    <span class="s3">assert </span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">layout </span><span class="s4">== </span><span class="s5">&quot;C&quot;</span>
    <span class="s3">return </span><span class="s1">SeriesType</span><span class="s4">(</span><span class="s1">arrty</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">namety</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">type_callable</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">type_series_constructor</span><span class="s4">(</span><span class="s1">context</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">typer</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">name</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">) </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">):</span>
            <span class="s3">assert </span><span class="s1">data</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
            <span class="s3">if </span><span class="s1">name </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">name </span><span class="s4">= </span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span>
            <span class="s3">return </span><span class="s1">SeriesType</span><span class="s4">(</span><span class="s1">data</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">name</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">typer</span>


<span class="s4">@</span><span class="s1">type_callable</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">type_index_constructor</span><span class="s4">(</span><span class="s1">context</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">typer</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">hashmap</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">):</span>
            <span class="s3">assert </span><span class="s1">data</span><span class="s4">.</span><span class="s1">layout </span><span class="s4">== </span><span class="s5">&quot;C&quot;</span>
            <span class="s3">assert </span><span class="s1">data</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s6">1</span>
            <span class="s3">assert </span><span class="s1">hashmap </span><span class="s3">is None or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">hashmap</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">DictType</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">IndexType</span><span class="s4">(</span><span class="s1">data</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">layout</span><span class="s4">=</span><span class="s1">data</span><span class="s4">.</span><span class="s1">layout</span><span class="s4">, </span><span class="s1">pyclass</span><span class="s4">=</span><span class="s1">Index</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">typer</span>


<span class="s0"># Backend extensions for Index and Series and Frame</span>
<span class="s4">@</span><span class="s1">register_model</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">IndexModel</span><span class="s4">(</span><span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s0"># We don't want the numpy string scalar type in our hashmap</span>
        <span class="s1">members </span><span class="s4">= [</span>
            <span class="s4">(</span><span class="s5">&quot;data&quot;</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">as_array</span><span class="s4">),</span>
            <span class="s0"># This is an attempt to emulate our hashtable code with a numba</span>
            <span class="s0"># typed dict</span>
            <span class="s0"># It maps from values in the index to their integer positions in the array</span>
            <span class="s4">(</span><span class="s5">&quot;hashmap&quot;</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">DictType</span><span class="s4">(</span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span><span class="s4">)),</span>
            <span class="s0"># Pointer to the Index object this was created from, or that it</span>
            <span class="s0"># boxes to</span>
            <span class="s0"># https://numba.discourse.group/t/qst-how-to-cache-the-boxing-of-an-object/2128/2?u=lithomas1</span>
            <span class="s4">(</span><span class="s5">&quot;parent&quot;</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">pyobject</span><span class="s4">),</span>
        <span class="s4">]</span>
        <span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">, </span><span class="s1">members</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">register_model</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">SeriesModel</span><span class="s4">(</span><span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">members </span><span class="s4">= [</span>
            <span class="s4">(</span><span class="s5">&quot;index&quot;</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">index</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">&quot;values&quot;</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">as_array</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">&quot;name&quot;</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">namety</span><span class="s4">),</span>
        <span class="s4">]</span>
        <span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">, </span><span class="s1">members</span><span class="s4">)</span>


<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">, </span><span class="s5">&quot;data&quot;</span><span class="s4">, </span><span class="s5">&quot;_data&quot;</span><span class="s4">)</span>
<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">, </span><span class="s5">&quot;hashmap&quot;</span><span class="s4">, </span><span class="s5">&quot;hashmap&quot;</span><span class="s4">)</span>

<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">, </span><span class="s5">&quot;index&quot;</span><span class="s4">, </span><span class="s5">&quot;index&quot;</span><span class="s4">)</span>
<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">, </span><span class="s5">&quot;values&quot;</span><span class="s4">, </span><span class="s5">&quot;values&quot;</span><span class="s4">)</span>
<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">, </span><span class="s5">&quot;name&quot;</span><span class="s4">, </span><span class="s5">&quot;name&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">pdseries_constructor</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s1">data</span><span class="s4">, </span><span class="s1">index </span><span class="s4">= </span><span class="s1">args</span>
    <span class="s1">series </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">)(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">)</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">index </span><span class="s4">= </span><span class="s1">index</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">values </span><span class="s4">= </span><span class="s1">data</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">name </span><span class="s4">= </span><span class="s1">context</span><span class="s4">.</span><span class="s1">get_constant</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">impl_ret_borrowed</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">, </span><span class="s1">series</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">unicode_type</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">pdseries_constructor_with_name</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s1">data</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">name </span><span class="s4">= </span><span class="s1">args</span>
    <span class="s1">series </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">)(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">)</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">index </span><span class="s4">= </span><span class="s1">index</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">values </span><span class="s4">= </span><span class="s1">data</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">name </span><span class="s4">= </span><span class="s1">name</span>
    <span class="s3">return </span><span class="s1">impl_ret_borrowed</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">, </span><span class="s1">series</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">DictType</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">pyobject</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">index_constructor_2arg</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">hashmap</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">) = </span><span class="s1">args</span>
    <span class="s1">index </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">)(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">)</span>

    <span class="s1">index</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap </span><span class="s4">= </span><span class="s1">hashmap</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">parent </span><span class="s4">= </span><span class="s1">parent</span>
    <span class="s3">return </span><span class="s1">impl_ret_borrowed</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">, </span><span class="s1">index</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">DictType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">index_constructor_2arg_parent</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s0"># Basically same as index_constructor_1arg, but also lets you specify the</span>
    <span class="s0"># parent object</span>
    <span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">hashmap</span><span class="s4">) = </span><span class="s1">args</span>
    <span class="s1">index </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">)(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">)</span>

    <span class="s1">index</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">data</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap </span><span class="s4">= </span><span class="s1">hashmap</span>
    <span class="s3">return </span><span class="s1">impl_ret_borrowed</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">, </span><span class="s1">index</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">Array</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">index_constructor_1arg</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s3">from </span><span class="s1">numba</span><span class="s4">.</span><span class="s1">typed </span><span class="s3">import </span><span class="s1">Dict</span>

    <span class="s1">key_type </span><span class="s4">= </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">.</span><span class="s1">dtype</span>
    <span class="s1">value_type </span><span class="s4">= </span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span>

    <span class="s3">def </span><span class="s1">index_impl</span><span class="s4">(</span><span class="s1">data</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">Index</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">.</span><span class="s1">empty</span><span class="s4">(</span><span class="s1">key_type</span><span class="s4">, </span><span class="s1">value_type</span><span class="s4">))</span>

    <span class="s3">return </span><span class="s1">context</span><span class="s4">.</span><span class="s1">compile_internal</span><span class="s4">(</span><span class="s1">builder</span><span class="s4">, </span><span class="s1">index_impl</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">)</span>


<span class="s0"># Helper to convert the unicodecharseq (numpy string scalar) into a unicode_type</span>
<span class="s0"># (regular string)</span>
<span class="s3">def </span><span class="s1">maybe_cast_str</span><span class="s4">(</span><span class="s1">x</span><span class="s4">):</span>
    <span class="s0"># Dummy function that numba can overload</span>
    <span class="s3">pass</span>


<span class="s4">@</span><span class="s1">overload</span><span class="s4">(</span><span class="s1">maybe_cast_str</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">maybe_cast_str_impl</span><span class="s4">(</span><span class="s1">x</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Converts numba UnicodeCharSeq (numpy string scalar) -&gt; unicode type (string). 
    Is a no-op for other types.&quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">UnicodeCharSeq</span><span class="s4">):</span>
        <span class="s3">return lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">str</span><span class="s4">(</span><span class="s1">x</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return lambda </span><span class="s1">x</span><span class="s4">: </span><span class="s1">x</span>


<span class="s4">@</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">unbox_index</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Convert a Index object to a native structure. 
 
    Note: Object dtype is not allowed here 
    &quot;&quot;&quot;</span>
    <span class="s1">data_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_getattr_string</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s5">&quot;_numba_data&quot;</span><span class="s4">)</span>
    <span class="s1">index </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">)(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">context</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">)</span>
    <span class="s0"># If we see an object array, assume its been validated as only containing strings</span>
    <span class="s0"># We still need to do the conversion though</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">as_array</span><span class="s4">, </span><span class="s1">data_obj</span><span class="s4">).</span><span class="s1">value</span>
    <span class="s1">typed_dict_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">numba</span><span class="s4">.</span><span class="s1">typed</span><span class="s4">.</span><span class="s1">Dict</span><span class="s4">))</span>
    <span class="s0"># Create an empty typed dict in numba for the hashmap for indexing</span>
    <span class="s0"># equiv of numba.typed.Dict.empty(typ.dtype, types.intp)</span>
    <span class="s1">arr_type_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">))</span>
    <span class="s1">intp_type_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span><span class="s4">))</span>
    <span class="s1">hashmap_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">call_method</span><span class="s4">(</span>
        <span class="s1">typed_dict_obj</span><span class="s4">, </span><span class="s5">&quot;empty&quot;</span><span class="s4">, (</span><span class="s1">arr_type_obj</span><span class="s4">, </span><span class="s1">intp_type_obj</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">DictType</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">intp</span><span class="s4">), </span><span class="s1">hashmap_obj</span><span class="s4">).</span><span class="s1">value</span>
    <span class="s0"># Set the parent for speedy boxing.</span>
    <span class="s1">index</span><span class="s4">.</span><span class="s1">parent </span><span class="s4">= </span><span class="s1">obj</span>

    <span class="s0"># Decrefs</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">data_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">arr_type_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">intp_type_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">typed_dict_obj</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">NativeValue</span><span class="s4">(</span><span class="s1">index</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">unbox_series</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">, </span><span class="s1">obj</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Convert a Series object to a native structure. 
    &quot;&quot;&quot;</span>
    <span class="s1">index_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_getattr_string</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s5">&quot;index&quot;</span><span class="s4">)</span>
    <span class="s1">values_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_getattr_string</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s5">&quot;values&quot;</span><span class="s4">)</span>
    <span class="s1">name_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_getattr_string</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s5">&quot;name&quot;</span><span class="s4">)</span>

    <span class="s1">series </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">)(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">context</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">)</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">index </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">index_obj</span><span class="s4">).</span><span class="s1">value</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">values </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">values</span><span class="s4">, </span><span class="s1">values_obj</span><span class="s4">).</span><span class="s1">value</span>
    <span class="s1">series</span><span class="s4">.</span><span class="s1">name </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">unbox</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">namety</span><span class="s4">, </span><span class="s1">name_obj</span><span class="s4">).</span><span class="s1">value</span>

    <span class="s0"># Decrefs</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">index_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">values_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">name_obj</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">NativeValue</span><span class="s4">(</span><span class="s1">series</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">())</span>


<span class="s4">@</span><span class="s1">box</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">box_index</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">, </span><span class="s1">val</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Convert a native index structure to a Index object. 
 
    If our native index is of a numpy string dtype, we'll cast it to 
    object. 
    &quot;&quot;&quot;</span>
    <span class="s0"># First build a Numpy array object, then wrap it in a Index</span>
    <span class="s1">index </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">)(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">context</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">val</span><span class="s4">)</span>

    <span class="s1">res </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">alloca_once_value</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">, </span><span class="s1">index</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">)</span>

    <span class="s0"># Does parent exist?</span>
    <span class="s0"># (it means already boxed once, or Index same as original df.index or df.columns)</span>
    <span class="s0"># xref https://github.com/numba/numba/blob/596e8a55334cc46854e3192766e643767bd7c934/numba/core/boxing.py#L593C17-L593C17</span>
    <span class="s3">with </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">.</span><span class="s1">if_else</span><span class="s4">(</span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">is_not_null</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">, </span><span class="s1">index</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">)) </span><span class="s3">as </span><span class="s4">(</span>
        <span class="s1">has_parent</span><span class="s4">,</span>
        <span class="s1">otherwise</span><span class="s4">,</span>
    <span class="s4">):</span>
        <span class="s3">with </span><span class="s1">has_parent</span><span class="s4">:</span>
            <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">incref</span><span class="s4">(</span><span class="s1">index</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">)</span>
        <span class="s3">with </span><span class="s1">otherwise</span><span class="s4">:</span>
            <span class="s0"># TODO: preserve the original class for the index</span>
            <span class="s0"># Also need preserve the name of the Index</span>
            <span class="s0"># class_obj = c.pyapi.unserialize(c.pyapi.serialize_object(typ.pyclass))</span>
            <span class="s1">class_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">Index</span><span class="s4">))</span>
            <span class="s1">array_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">box</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">as_array</span><span class="s4">, </span><span class="s1">index</span><span class="s4">.</span><span class="s1">data</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">types</span><span class="s4">.</span><span class="s1">UnicodeCharSeq</span><span class="s4">):</span>
                <span class="s0"># We converted to numpy string dtype, convert back</span>
                <span class="s0"># to object since _simple_new won't do that for uss</span>
                <span class="s1">object_str_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s5">&quot;object&quot;</span><span class="s4">))</span>
                <span class="s1">array_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">call_method</span><span class="s4">(</span><span class="s1">array_obj</span><span class="s4">, </span><span class="s5">&quot;astype&quot;</span><span class="s4">, (</span><span class="s1">object_str_obj</span><span class="s4">,))</span>
                <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">object_str_obj</span><span class="s4">)</span>
            <span class="s0"># this is basically Index._simple_new(array_obj, name_obj) in python</span>
            <span class="s1">index_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">call_method</span><span class="s4">(</span><span class="s1">class_obj</span><span class="s4">, </span><span class="s5">&quot;_simple_new&quot;</span><span class="s4">, (</span><span class="s1">array_obj</span><span class="s4">,))</span>
            <span class="s1">index</span><span class="s4">.</span><span class="s1">parent </span><span class="s4">= </span><span class="s1">index_obj</span>
            <span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">.</span><span class="s1">store</span><span class="s4">(</span><span class="s1">index_obj</span><span class="s4">, </span><span class="s1">res</span><span class="s4">)</span>

            <span class="s0"># Decrefs</span>
            <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">class_obj</span><span class="s4">)</span>
            <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">array_obj</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">.</span><span class="s1">load</span><span class="s4">(</span><span class="s1">res</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">box</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">box_series</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">, </span><span class="s1">val</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Convert a native series structure to a Series object. 
    &quot;&quot;&quot;</span>
    <span class="s1">series </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">)(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">context</span><span class="s4">, </span><span class="s1">c</span><span class="s4">.</span><span class="s1">builder</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">val</span><span class="s4">)</span>
    <span class="s1">series_const_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">Series</span><span class="s4">.</span><span class="s1">_from_mgr</span><span class="s4">))</span>
    <span class="s1">mgr_const_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">unserialize</span><span class="s4">(</span>
        <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">serialize_object</span><span class="s4">(</span><span class="s1">SingleBlockManager</span><span class="s4">.</span><span class="s1">from_array</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">index_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">box</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">series</span><span class="s4">.</span><span class="s1">index</span><span class="s4">)</span>
    <span class="s1">array_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">box</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">as_array</span><span class="s4">, </span><span class="s1">series</span><span class="s4">.</span><span class="s1">values</span><span class="s4">)</span>
    <span class="s1">name_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">box</span><span class="s4">(</span><span class="s1">typ</span><span class="s4">.</span><span class="s1">namety</span><span class="s4">, </span><span class="s1">series</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s0"># This is basically equivalent of</span>
    <span class="s0"># pd.Series(data=array_obj, index=index_obj)</span>
    <span class="s0"># To improve perf, we will construct the Series from a manager</span>
    <span class="s0"># object to avoid checks.</span>
    <span class="s0"># We'll also set the name attribute manually to avoid validation</span>
    <span class="s1">mgr_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">call_function_objargs</span><span class="s4">(</span>
        <span class="s1">mgr_const_obj</span><span class="s4">,</span>
        <span class="s4">(</span>
            <span class="s1">array_obj</span><span class="s4">,</span>
            <span class="s1">index_obj</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s1">mgr_axes_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_getattr_string</span><span class="s4">(</span><span class="s1">mgr_obj</span><span class="s4">, </span><span class="s5">&quot;axes&quot;</span><span class="s4">)</span>
    <span class="s0"># Series._constructor_from_mgr(mgr, axes)</span>
    <span class="s1">series_obj </span><span class="s4">= </span><span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">call_function_objargs</span><span class="s4">(</span>
        <span class="s1">series_const_obj</span><span class="s4">, (</span><span class="s1">mgr_obj</span><span class="s4">, </span><span class="s1">mgr_axes_obj</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">object_setattr_string</span><span class="s4">(</span><span class="s1">series_obj</span><span class="s4">, </span><span class="s5">&quot;_name&quot;</span><span class="s4">, </span><span class="s1">name_obj</span><span class="s4">)</span>

    <span class="s0"># Decrefs</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">series_const_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">mgr_axes_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">mgr_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">mgr_const_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">index_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">array_obj</span><span class="s4">)</span>
    <span class="s1">c</span><span class="s4">.</span><span class="s1">pyapi</span><span class="s4">.</span><span class="s1">decref</span><span class="s4">(</span><span class="s1">name_obj</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">series_obj</span>


<span class="s0"># Add common series reductions (e.g. mean, sum),</span>
<span class="s0"># and also add common binops (e.g. add, sub, mul, div)</span>
<span class="s3">def </span><span class="s1">generate_series_reduction</span><span class="s4">(</span><span class="s1">ser_reduction</span><span class="s4">, </span><span class="s1">ser_method</span><span class="s4">):</span>
    <span class="s4">@</span><span class="s1">overload_method</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">, </span><span class="s1">ser_reduction</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">series_reduction</span><span class="s4">(</span><span class="s1">series</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">series_reduction_impl</span><span class="s4">(</span><span class="s1">series</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">ser_method</span><span class="s4">(</span><span class="s1">series</span><span class="s4">.</span><span class="s1">values</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">series_reduction_impl</span>

    <span class="s3">return </span><span class="s1">series_reduction</span>


<span class="s3">def </span><span class="s1">generate_series_binop</span><span class="s4">(</span><span class="s1">binop</span><span class="s4">):</span>
    <span class="s4">@</span><span class="s1">overload</span><span class="s4">(</span><span class="s1">binop</span><span class="s4">)</span>
    <span class="s3">def </span><span class="s1">series_binop</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">, </span><span class="s1">SeriesType</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">SeriesType</span><span class="s4">):</span>

                <span class="s3">def </span><span class="s1">series_binop_impl</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">, </span><span class="s1">series2</span><span class="s4">):</span>
                    <span class="s0"># TODO: Check index matching?</span>
                    <span class="s3">return </span><span class="s1">Series</span><span class="s4">(</span>
                        <span class="s1">binop</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">.</span><span class="s1">values</span><span class="s4">, </span><span class="s1">series2</span><span class="s4">.</span><span class="s1">values</span><span class="s4">),</span>
                        <span class="s1">series1</span><span class="s4">.</span><span class="s1">index</span><span class="s4">,</span>
                        <span class="s1">series1</span><span class="s4">.</span><span class="s1">name</span><span class="s4">,</span>
                    <span class="s4">)</span>

                <span class="s3">return </span><span class="s1">series_binop_impl</span>
            <span class="s3">else</span><span class="s4">:</span>

                <span class="s3">def </span><span class="s1">series_binop_impl</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">, </span><span class="s1">value</span><span class="s4">):</span>
                    <span class="s3">return </span><span class="s1">Series</span><span class="s4">(</span>
                        <span class="s1">binop</span><span class="s4">(</span><span class="s1">series1</span><span class="s4">.</span><span class="s1">values</span><span class="s4">, </span><span class="s1">value</span><span class="s4">), </span><span class="s1">series1</span><span class="s4">.</span><span class="s1">index</span><span class="s4">, </span><span class="s1">series1</span><span class="s4">.</span><span class="s1">name</span>
                    <span class="s4">)</span>

                <span class="s3">return </span><span class="s1">series_binop_impl</span>

    <span class="s3">return </span><span class="s1">series_binop</span>


<span class="s1">series_reductions </span><span class="s4">= [</span>
    <span class="s4">(</span><span class="s5">&quot;sum&quot;</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s5">&quot;mean&quot;</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">mean</span><span class="s4">),</span>
    <span class="s0"># Disabled due to discrepancies between numba std. dev</span>
    <span class="s0"># and pandas std. dev (no way to specify dof)</span>
    <span class="s0"># (&quot;std&quot;, np.std),</span>
    <span class="s0"># (&quot;var&quot;, np.var),</span>
    <span class="s4">(</span><span class="s5">&quot;min&quot;</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">),</span>
    <span class="s4">(</span><span class="s5">&quot;max&quot;</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">),</span>
<span class="s4">]</span>
<span class="s3">for </span><span class="s1">reduction</span><span class="s4">, </span><span class="s1">reduction_method </span><span class="s3">in </span><span class="s1">series_reductions</span><span class="s4">:</span>
    <span class="s1">generate_series_reduction</span><span class="s4">(</span><span class="s1">reduction</span><span class="s4">, </span><span class="s1">reduction_method</span><span class="s4">)</span>

<span class="s1">series_binops </span><span class="s4">= [</span><span class="s1">operator</span><span class="s4">.</span><span class="s1">add</span><span class="s4">, </span><span class="s1">operator</span><span class="s4">.</span><span class="s1">sub</span><span class="s4">, </span><span class="s1">operator</span><span class="s4">.</span><span class="s1">mul</span><span class="s4">, </span><span class="s1">operator</span><span class="s4">.</span><span class="s1">truediv</span><span class="s4">]</span>

<span class="s3">for </span><span class="s1">ser_binop </span><span class="s3">in </span><span class="s1">series_binops</span><span class="s4">:</span>
    <span class="s1">generate_series_binop</span><span class="s4">(</span><span class="s1">ser_binop</span><span class="s4">)</span>


<span class="s0"># get_loc on Index</span>
<span class="s4">@</span><span class="s1">overload_method</span><span class="s4">(</span><span class="s1">IndexType</span><span class="s4">, </span><span class="s5">&quot;get_loc&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">index_get_loc</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">index_get_loc_impl</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
        <span class="s0"># Initialize the hash table if not initialized</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap</span><span class="s4">) == </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">val </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">index</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">):</span>
                <span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap</span><span class="s4">[</span><span class="s1">val</span><span class="s4">] = </span><span class="s1">i</span>
        <span class="s3">return </span><span class="s1">index</span><span class="s4">.</span><span class="s1">hashmap</span><span class="s4">[</span><span class="s1">item</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">index_get_loc_impl</span>


<span class="s0"># Indexing for Series/Index</span>
<span class="s4">@</span><span class="s1">overload</span><span class="s4">(</span><span class="s1">operator</span><span class="s4">.</span><span class="s1">getitem</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">series_indexing</span><span class="s4">(</span><span class="s1">series</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">series</span><span class="s4">, </span><span class="s1">SeriesType</span><span class="s4">):</span>

        <span class="s3">def </span><span class="s1">series_getitem</span><span class="s4">(</span><span class="s1">series</span><span class="s4">, </span><span class="s1">item</span><span class="s4">):</span>
            <span class="s1">loc </span><span class="s4">= </span><span class="s1">series</span><span class="s4">.</span><span class="s1">index</span><span class="s4">.</span><span class="s1">get_loc</span><span class="s4">(</span><span class="s1">item</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">series</span><span class="s4">.</span><span class="s1">iloc</span><span class="s4">[</span><span class="s1">loc</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">series_getitem</span>


<span class="s4">@</span><span class="s1">overload</span><span class="s4">(</span><span class="s1">operator</span><span class="s4">.</span><span class="s1">getitem</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">index_indexing</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">idx</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">IndexType</span><span class="s4">):</span>

        <span class="s3">def </span><span class="s1">index_getitem</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, </span><span class="s1">idx</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">index</span><span class="s4">.</span><span class="s1">_data</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">index_getitem</span>


<span class="s3">class </span><span class="s1">IlocType</span><span class="s4">(</span><span class="s1">types</span><span class="s4">.</span><span class="s1">Type</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">obj_type</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">obj_type </span><span class="s4">= </span><span class="s1">obj_type</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s5">f&quot;iLocIndexer(</span><span class="s3">{</span><span class="s1">obj_type</span><span class="s3">}</span><span class="s5">)&quot;</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">key</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">obj_type</span>


<span class="s4">@</span><span class="s1">typeof_impl</span><span class="s4">.</span><span class="s1">register</span><span class="s4">(</span><span class="s1">_iLocIndexer</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">typeof_iloc</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">c</span><span class="s4">):</span>
    <span class="s1">objtype </span><span class="s4">= </span><span class="s1">typeof_impl</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">c</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">IlocType</span><span class="s4">(</span><span class="s1">objtype</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">type_callable</span><span class="s4">(</span><span class="s1">_iLocIndexer</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">type_iloc_constructor</span><span class="s4">(</span><span class="s1">context</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">typer</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">SeriesType</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">IlocType</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">typer</span>


<span class="s4">@</span><span class="s1">lower_builtin</span><span class="s4">(</span><span class="s1">_iLocIndexer</span><span class="s4">, </span><span class="s1">SeriesType</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">iloc_constructor</span><span class="s4">(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">, </span><span class="s1">args</span><span class="s4">):</span>
    <span class="s4">(</span><span class="s1">obj</span><span class="s4">,) = </span><span class="s1">args</span>
    <span class="s1">iloc_indexer </span><span class="s4">= </span><span class="s1">cgutils</span><span class="s4">.</span><span class="s1">create_struct_proxy</span><span class="s4">(</span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">)(</span><span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">)</span>
    <span class="s1">iloc_indexer</span><span class="s4">.</span><span class="s1">obj </span><span class="s4">= </span><span class="s1">obj</span>
    <span class="s3">return </span><span class="s1">impl_ret_borrowed</span><span class="s4">(</span>
        <span class="s1">context</span><span class="s4">, </span><span class="s1">builder</span><span class="s4">, </span><span class="s1">sig</span><span class="s4">.</span><span class="s1">return_type</span><span class="s4">, </span><span class="s1">iloc_indexer</span><span class="s4">.</span><span class="s1">_getvalue</span><span class="s4">()</span>
    <span class="s4">)</span>


<span class="s4">@</span><span class="s1">register_model</span><span class="s4">(</span><span class="s1">IlocType</span><span class="s4">)</span>
<span class="s3">class </span><span class="s1">ILocModel</span><span class="s4">(</span><span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">members </span><span class="s4">= [(</span><span class="s5">&quot;obj&quot;</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">.</span><span class="s1">obj_type</span><span class="s4">)]</span>
        <span class="s1">models</span><span class="s4">.</span><span class="s1">StructModel</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">dmm</span><span class="s4">, </span><span class="s1">fe_type</span><span class="s4">, </span><span class="s1">members</span><span class="s4">)</span>


<span class="s1">make_attribute_wrapper</span><span class="s4">(</span><span class="s1">IlocType</span><span class="s4">, </span><span class="s5">&quot;obj&quot;</span><span class="s4">, </span><span class="s5">&quot;obj&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">overload_attribute</span><span class="s4">(</span><span class="s1">SeriesType</span><span class="s4">, </span><span class="s5">&quot;iloc&quot;</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">series_iloc</span><span class="s4">(</span><span class="s1">series</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">get</span><span class="s4">(</span><span class="s1">series</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">_iLocIndexer</span><span class="s4">(</span><span class="s1">series</span><span class="s4">)</span>

    <span class="s3">return </span><span class="s1">get</span>


<span class="s4">@</span><span class="s1">overload</span><span class="s4">(</span><span class="s1">operator</span><span class="s4">.</span><span class="s1">getitem</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">iloc_getitem</span><span class="s4">(</span><span class="s1">iloc_indexer</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">iloc_indexer</span><span class="s4">, </span><span class="s1">IlocType</span><span class="s4">):</span>

        <span class="s3">def </span><span class="s1">getitem_impl</span><span class="s4">(</span><span class="s1">iloc_indexer</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">iloc_indexer</span><span class="s4">.</span><span class="s1">obj</span><span class="s4">.</span><span class="s1">values</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">getitem_impl</span>
</pre>
</body>
</html>